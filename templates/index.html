<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <title>Santa Barbara High School</title>
  </head>
  <body>
  	<div id="home-page">
  	  <h1>Santa Barbara High School Platform</h1>
  	</div>
  	<div id="space-search">
  	  <div id="user-directory">
  	    <h1>User Directory</h1>
  	  </div>
  	  <div id="space-directory-lfg">
  	  	<h1>Club Directory</h1>
  	    <img id="close-space-search-button" src="/static/images/back.png">
  	  </div>
  	</div>
    <div id="first-all">
      <div id="content">
        <div id="header">
          <span id="header_text"></span>
          <img id="create-section-button" src="/static/images/settings-white.png">
        </div>
        <div id="information">
          <img id="home" src="/static/images/home-white.png">
        </div>
        <div id="channels"></div>
<!--         when new message is sent, make the new message appear above the message bar and not mess up the scrolling (Safari only). -->
        <div id="chats">
          <div id="chat">
            <div id="messages">
            </div>
          </div>
          <form id="message_input_form">
            <!--see w3schools input attributes like max char, spam, etc. -->
            <textarea id="message_input" rows="1" placeholder="Enter message"></textarea>
<!--             <input type="text" id="message_input" placeholder="Enter message"> -->
              <button type="submit" id="submit"><img id="send" src="/static/images/send.png" alt="Send"></button>
          </form>
          <span id="typing_display"></span>
        </div>
        <div id="members">
        </div>
      </div>
    </div>
    <div id="footer">
      <div id="profile">
        <!-- load exclamation mark icon if not showing -->
        <img src={{ picture }} alt="pfp" id="profile_picture">
        <p id="username">{{ name }}</p>
        <p id="student_id">Santa Barbara High School</p>
        <p id="settings">#</p>
      </div>
      <div id="spaces">
        <span id="space_align_helper"></span>
          <button type="button" id="create-space-button"><img src="/static/images/ppicons-plus.svg" alt="create" style="width:25px;height:25px;"></button>
          <button type="button" id="space-search-button"><img src="/static/images/ppicons-plus.svg" alt="create" style="width:25px;height:25px;"></button>
        </div>
      </div>
    </div>
    <div id="create-space" class="modal">
      <div class="modal-content">
        <span id="close-create-space" class="close">&times;</span>
        <form id="create-space-form">
          <label for="space-name">Space Name:</label><br>
          <input type="text" id="space-name"><br>
          <input type="submit" value="Submit">
        </form>
      </div>
    </div>
    <div id="create-room" class="modal">
      <div class="modal-content">
        <span id="close-create-room" class="close">&times;</span>
        <form id="create-room-form">
          <label for="room-name">Room Name:</label><br>
          <input type="text" id="room-name"><br>
          <input type="submit" value="Submit">
        </form>
      </div>
    </div>
    <div id="create-section" class="modal">
      <div class="modal-content">
        <span id="close-create-section" class="close">&times;</span>
        <form id="create-section-form">
          <label for="section-name">Section Name:</label><br>
          <input type="text" id="section-name"><br>
          <input type="submit" value="Submit">
        </form>
      </div>
    </div>
  </body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.2/moment.min.js"></script>
  <script type="text/javascript" charset="utf-8">
    var socket = io();
    var chat_history_skip = 0;
    var current_room = '';
    var old_room = '';
    var typing = false;
    var timeout = null;
    var current_space = '';
    var typing_list = [];
    var selected_section = '';
    var background_page = 0;
    
    // list of messages being typed by user containing message (updated when user clicks on space or another room) and room id.
    // ['2hu45iu2323', 'Hi I love apples and cakes they are cool', '34yubjub42', 'I love appels']
    // Loop through this and check if joined room id is equal to any of these. If so, get index of that ID add one and make the message that message. Yep okay easy peasy lemon SQUEEEEZY.
    $(document).on('click', '.section', function() {
      selected_section = this.id;
    });
    
    function stoppedTyping() {
      typing = false;
      socket.emit('stopped_typing', {
        name: "{{ name }}",
        room: current_room
      });
    }
    function isTyping() {
      if (typing == false) {
        typing = true;
        socket.emit('is_typing', {
          name: "{{ name }}",
          room: current_room
        });
        timeout = setTimeout(stoppedTyping, 5000);
      }
      else {
        clearTimeout(timeout);
        timeout = setTimeout(stoppedTyping, 5000);
      }
    }
    
    $(window).on("load", function() { 
      $.ajax({
        type: 'POST',
        url: '/list_spaces',
        dataType: "json",
        success: function(spaces_list) {
          spaces_list.forEach(function(item) {
            const newNode = document.createElement('div');
            newNode.className = 'space-wrapper';
            
            var newNodeChild = document.createElement('img');
            newNodeChild.className = 'space';
            newNodeChild.id = item._id.$oid;
            newNodeChild.setAttribute('data-name', item.name);
            newNodeChild.src = '/static/images/Space.jpeg';
            newNode.appendChild(newNodeChild);
            
            newNodeChild = document.createElement('div');
            newNodeChild.className = 'active-space';
            newNode.appendChild(newNodeChild);
            
            referenceNode = document.getElementById('space_align_helper');
            referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
          });
        }
      });
    });
    
    $('#chat').scroll(function() { //$('#chat').scrollTop() + $('#chat').height();
      if (Math.abs($('#chat').scrollTop()) == document.getElementById("chat").scrollHeight - document.getElementById("chat").offsetHeight) {  
        loadChatHistory();
      }
    });
    
    let message_input = document.getElementById("message_input");
    message_input.oninput = function() {
      message_input.style.height = "";
      message_input.style.height = Math.min(message_input.scrollHeight, 300) + "px";
    }; 
    $(message_input).keypress(function (e) {
      if(e.which === 13 && !e.shiftKey) {
        e.preventDefault();
        $(document.getElementById('message_input_form')).submit();
        message_input.setAttribute("style", "");
        message_input.value = "";
//       put placeholder message (message is loading but is faded out to account for lag time or disconnected if wanted)
      }
      else {
      	isTyping();
      }
    });
    
    document.getElementById('message_input_form').onsubmit = function (e) {
      e.preventDefault();
      let message = message_input.value.trim();
      document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight; 
      stoppedTyping();
      clearTimeout(timeout);
      if (message.length) {
        socket.emit('send_message', {
          name: "{{ name }}",
          room: current_room,
          picture: "{{ picture }}",
          message: message
        });
      }
      message_input.value = '';
      message_input.focus();
    }

    socket.on('recieve_message', function (data) {
      const newMode = document.createElement('div');
      var messageMoment = moment(data.datetime).local().format('h:mm A');
      if (data.combine == 'false') {
        newMode.className = 'message-container';
        messageMoment = 'at ' + messageMoment;
        // Give pfp image default fallback image
        newMode.innerHTML = '<img class="pfp" src="' + data.picture + '" alt="!"> <p class="message-title"> <span class="name"> <b>' + data.name + ' </b> </span> <span class="datetime">' + messageMoment + '</span> </p> <p class="message">' + data.message + '</p>';
      }
      else {
        newMode.className = 'message-container-combine';
        newMode.innerHTML = '<p class="message-combine-time">' + messageMoment + '</p><p class="message-combine">' + data.message + '</p>';
      }
      document.getElementById('messages').append(newMode);
    });
    
    socket.on('is_typing', function (data) {
      if (!typing_list.includes(data.name) && data.name != "{{ name }}") {
        typing_list.push(data.name);
      }
      changeTypingDisplay();
    });
    
    socket.on('stopped_typing', function (data) {
      if (typing_list.includes(data.name)) {
        const index = typing_list.indexOf(data.name);
        if (index > -1) {
          typing_list.splice(index, 1); 
        }
        changeTypingDisplay();
      }
    });
    
    socket.on('deleted_room', function(data) {
      if (data.room == current_room) {
        joinRoom($('#channels').find('.room')[0].id);
      }
      $(document.getElementById(data.room)).remove();
    });
    
    let typing_display = document.getElementById('typing_display');
    function changeTypingDisplay() {
      if (typing_list.length == 0) {
        typing_display.textContent = '';
      }
      else if (typing_list.length == 1) {
        typing_display.innerHTML = '<b>' + typing_list[0] + '</b> is typing...';
      }
      else if (typing_list.length == 2) {
        typing_display.innerHTML = '<b>' + typing_list[0] + '</b> and <b>' + typing_list[1] + '</b> are typing...';
      }
      else if (typing_list.length == 3) {
        typing_display.innerHTML = '<b>' + typing_list[0] + '</b>, <b>' + typing_list[1] + '</b>, and <b>' + typing_list[2] + '</b> are typing...';
      }
      else {
        typing_display.innerHTML = '<b>' + typing_list[0] + '</b>, <b>' + typing_list[1] + '</b>, <b>' + typing_list[2] + '</b>, and' + String(typing_list.length - 3) + ' others are typing...';
      }
    }
    
    function loadChatHistory() {
      $.ajax({
        type: 'POST',
        url: '/chat_history',
        dataType: "json",
        data: JSON.stringify({'i': String(chat_history_skip), 'room': current_room}),
        contentType: 'application/json;charset=UTF-8',
        success: function(chat_history) {
          chat_history_skip += 100;
          //var nowMomentTwo = DateTime.utc().toLocal();
          var todayDate = moment();
          var yesterdayDate = moment().subtract(1, 'day');
          
          var timeDisplayMode = 0;
          chat_history.forEach(function(item) {
            var messageDate = moment(item.datetime);
            var messageMoment = moment.utc(item.datetime).local();
            const newMode = document.createElement('div');
            if (item.combine == 'false') {
              newMode.className = 'message-container';
              if(moment(messageDate).isSame(todayDate, 'day')) {
                messageDate = 'at ' + messageDate.format('h:mm A');
              }
              else if(moment(messageDate).isSame(yesterdayDate, 'day')) {
                messageDate = 'Yesterday at ' + messageDate.format('h:mm A');
              }
              else {
                  messageDate = 'on ' + messageDate.format('M/D/YYYY');
              }
              newMode.innerHTML = '<img class="pfp" src="' + item.picture + '" alt="!"> <p class="message-title"> <span class="name"> <b>' + item.name + ' </b> </span> <span class="datetime">' + messageDate + '</span> </p> <p class="message">' + item.message + '</p>';
            }
            else {
              newMode.className = 'message-container-combine';
              newMode.innerHTML = '<p class="message-combine-time">' + messageDate.format('h:mm A') + '</p><p class="message-combine">' + item.message + '</p>';
            }
            document.getElementById('messages').prepend(newMode);
          });
        } 
      });
    }
    
    document.getElementById('create-room-form').onsubmit = function (e) {
      e.preventDefault();
      let room_name = document.getElementById('room-name').value.trim();
      if (room_name.length) {
        $.ajax({
          type: 'POST',
          url: '/create_room',
          dataType: 'json',
          data: JSON.stringify({'room_name': room_name, 'section_id': selected_section, 'space_id': current_space}),
          contentType: 'application/json;charset=UTF-8',
          success: function(room) {
            var room_list = [];
          	document.querySelectorAll(".room").forEach(function(item) {
          	  room_list.push(item.id);
          	});
            socket.emit('created_room', {
              created_room: room['_id']['$oid'],
              room_list: room_list,
              name: room_name,
              section_id: selected_section
            });
            document.getElementById("create-room").style.display = "none";
          }
        });
      }
    }
    
    socket.on('created_room', function(data) {
      const newNode = document.createElement('div');
      newNode.id = data.created_room;
      newNode.className = 'room';
      newNode.setAttribute('data-section', data.section_id);
      newNode.innerHTML = data.name + '<img class="room-settings" src="/static/images/settings-white.png">';
      document.getElementById('channels').append(newNode);
    });
    
    document.getElementById('create-space-form').onsubmit = function (e) {
      e.preventDefault();
      let space_name = document.getElementById('space-name').value.trim();
      if (space_name.length) { 
        $.ajax({
          type: 'POST',
          url: '/create_space',
          dataType: "json",
          data: JSON.stringify({'space_name': space_name}),
          contentType: 'application/json;charset=UTF-8',
          success: function(room_and_section) {
            $(document.getElementById(current_space)).closest('.space-wrapper').find('.active-space').css('visibility', 'hidden');
            document.getElementById("create-space").style.display = "none";
          	current_space = room_and_section[0][0]['space'];
            document.getElementById('messages').textContent = '';
            document.getElementById('channels').textContent = ''; 
            document.getElementById('header_text').textContent = space_name; 
            var newNode = document.createElement('div');
            newNode.className = 'space-wrapper';
            var newNodeChild = document.createElement('img');
            newNodeChild.className = 'space';
            newNodeChild.id = current_space;
            newNodeChild.setAttribute('data-name', space_name);
            newNodeChild.src = '/static/images/Space.jpeg';
            newNode.appendChild(newNodeChild);
            newNodeChild = document.createElement('div');
            newNodeChild.className = 'active-space';
            newNodeChild.style.visibility = 'visible';
            newNode.appendChild(newNodeChild);
            referenceNode = document.getElementById('space_align_helper');
            referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
            newNode = document.createElement('div');
            newNode.className = 'section';
            newNode.id = room_and_section[1][0]['_id']['$oid'];
            newNode.innerHTML = '<div class="section-name">' + room_and_section[1][0]['name'] + '</div><div class="create-room-button" type="button">+</div>'
            document.getElementById('channels').append(newNode);
            newNode = document.createElement('div');
          	newNode.className = 'room';
          	newNode.id = room_and_section[0][0]['_id']['$oid'];
          	newNode.innerHTML = 'general<img class="room-settings" src="/static/images/settings-white.png">';
          	document.getElementById('channels').append(newNode);
            document.getElementById('channels').append(newNode);
            $('#home-page').css('display', 'none');
            $('#first-all').css('display', 'block');
            $('#space-search').css('display', 'none');
            joinRoom(room_and_section[0][0]['_id']['$oid']);
          }
        });
      }
    }

    $(document).on('click', '.space', function() { //do not do anything if user already on clicked space
      if (current_space != this.id) {
        background_page = 1;
        $(document.getElementById(current_space)).closest('.space-wrapper').find('.active-space').css('width', '0px');
        $(this).closest('.space-wrapper').find('.active-space').css({width: '39px', WebkitTransition: 'opacity 1s ease-in-out', MozTransition: 'opacity 1s ease-in-out', MsTransition: 'opacity 1s ease-in-out', OTransition: 'opacity 1s ease-in-out', transition: 'opacity 1s ease-in-out'});
        current_space = this.id;
        $.ajax({
          type: "POST",
          url: '/space',
          dataType: "json",
          data: JSON.stringify({'space_id': current_space}), //JSOn.stringify
          contentType: 'application/json;charset=UTF-8',
          success: function(rooms_and_sections) {
            document.getElementById('messages').textContent = '';
            document.getElementById('header_text').textContent = document.getElementById(rooms_and_sections[0][0]['space']).getAttribute('data-name');
            document.getElementById('channels').textContent = ''; 
            var newNode = null;
            rooms_and_sections[1].forEach(function(section) {
              newNode = document.createElement('div');
              newNode.className = 'section';
              newNode.id = section['_id']['$oid'];
              newNode.innerHTML = '<div class="section-name">' + section['name'] + '</div><div class="create-room-button" type="button">+</div>'
              document.getElementById('channels').append(newNode);
              rooms_and_sections[0].forEach(function(room) {
                if (room['section'] == section['_id']['$oid']) {
                  newNode = document.createElement('div');
                  newNode.className = 'room';
              	  newNode.id = room['_id']['$oid'];
              	  newNode.setAttribute('data-section', room['section']);
              	  newNode.innerHTML = room['name'] + '<img class="room-settings" src="/static/images/settings-white.png">';
               	  document.getElementById('channels').append(newNode);
                }
              });
            });
            joinRoom(rooms_and_sections[0][0]['_id']['$oid']);
            $('#home-page').css('display', 'none');
            $('#first-all').css('display', 'block');
            $('#space-search').css('display', 'none');
          }
        });
      }
    });
    
    $(document).on('click', '#home', function() {
      background_page = 0;
      current_space = '';
      current_room = '';
      $('.active-space').css('visibility', 'hidden');
      $('#home-page').css('display', 'block');
      $('#first-all').css('display', 'none');
      $('#space-search').css('display', 'none');
    });
    
	$(document).on('click', '.room', function(e) {
	  if (e.target.className == 'room-settings') {
	    const deleted_room = $(this).attr('id');
	    const deleted_room_section = $(this).attr('data-section');
          $.ajax({
            type: "POST",
            url: '/delete_room',
        	dataType: "json",
        	data: JSON.stringify({'room_id': deleted_room, 'space_id': current_space, 'section_id': deleted_room_section}),
        	contentType: 'application/json;charset=UTF-8',
        	success: function(data) {
          	if (data['success'] == 'true') {
          	  var room_list = [];
          	  document.querySelectorAll(".room").forEach(function(item) {
          	    room_list.push(item.id);
          	  });
              socket.emit('deleted_room', {
                room: deleted_room,
                room_list: room_list
              });
            }
            else {
              alert('Spaces must have at least one room');
            }
          }
        });
	  }
	  else {
	    joinRoom(this.id);
	  }
	});
    
	function joinRoom(room_id) {
	  if (current_room != room_id) {
	    old_room = current_room;
  	    current_room = room_id;
  	    socket.emit('join_room', {
          room: current_room,
          old_room: old_room
        });
        $(document.getElementById(current_room)).attr('style', 'background-color: #43474d !important');
        $(document.getElementById(old_room)).attr('style', '');
        document.getElementById('messages').textContent = '';
        chat_history_skip = 0;
        loadChatHistory();
        typing_display.textContent = '';
        typing_list = [];
        stoppedTyping();
      }
	}
	
	$(document).on('click', '#space-search-button', function() {
	  if (background_page == 0) {
	    $('#home-page').css('display', 'none');
	    $('#space-search').css('display', 'block');
	  }
	  else {
	    $('#first-all').css('display', 'none');
	  }
	  $('#footer').css('display', 'none');
	  $('#space-search').css('display', 'block');
    });
    
    $(document).on('click', '#close-space-search-button', function() {
      if (background_page == 0) {
        $('#home-page').css('display', 'block');
      }
      else {
        $('#first-all').css('display', 'block');
      }
      $('#footer').css('display', 'flex');
      $('#space-search').css('display', 'none');
    });
    
  </script>
</html>
